# Analysis tools

Analysis tools are programs that analyse source code. For the purposes
of CVE benchmarking, analysis tools are expected to identify the
weaknesses in the source code that resulted in the vulnerability
of a CVE.

Analysis tools drivers are small scripts that acts as the interface
between the analysis tools and the CVE benchmarking tooling.

The purpose of an analysis tool driver is to execute its analysis tool
appropriately on the relevant commits of a CVE and convert its results
to a common form that benchmark reports can be generated from.

## Supported analysis tools

The [contrib/tools](contrib/tools) directory contains analysis tool
drivers that have been contributed by the community. The naming of
these directories is not significant, and drivers do not
have to be in this directory in order to be used by `bin/cli run ...`.

Some versions of the following analysis tools are supported with drivers (sorted alphabetically):

| Analysis tool                                                              | Driver location                                      |
|----------------------------------------------------------------------------|------------------------------------------------------|
| [CodeQL](https://securitylab.github.com/tools/codeql)                      | [contrib/tools/codeql](contrib/tools/codeql)         |
| [eslint](https://eslint.org/)                                              | [contrib/tools/eslint](contrib/tools/eslint)         |
| [Fortify](https://www.microfocus.com/en-us/solutions/application-security) | [contrib/tools/fortify](contrib/tools/fortify)       |
| [nodejsscan](https://github.com/ajinabraham/nodejsscan)                    | [contrib/tools/nodejsscan](contrib/tools/nodejsscan) |

Additional drivers may exist, ask the analysis tool vendors about
their level of support.

## Running analysis tools

Before `bin/cli run` can be used for an analysis tool, the analysis
tool needs to be set up and the corresponding driver
must be configured in a configuration file (by default:
`config.json` in the working directory of `bin/cli run`).

Each driver describes how these two steps can be
performed. See [eslint/README.md](contrib/tools/eslint/README.md) as
an example, or just try to run
[eslint/bin/install.sh](contrib/tools/eslint/bin.sh).

Common for all drivers is that they must have an entry
in the `tools` section of a configuration file, see
[configuration.md](docs/configuration.md) for details. Below is an
example configuration file that enables the `eslint` analysis tool to
be run with `bin/cli run eslint-default`:

```json
{
    "tools": {
        "eslint-default": {
            "bin": "node",
            "args": [
                "/home/user-name/ossf-cve-benchmark/build/ts/contrib/tools/eslint/src/eslint.js",
                "/home/user-name/analysis-tools/eslint-default"
            ]
        }
    }
}
```

With this setup, `eslint` can be run on the vulnerable and fixed commits of all 2020 CVEs like this:

```
$ bin/cli run --tool eslint-default year:2020
```

## Writing analysis tool drivers

To add support for a new driver, add a new directory to
the [contrib/tools](contrib/tools), then do the following in that
directory:

- Add a `README.md` file that describes how the analysis tool can be
  installed, and how the driver can be configured.
- Optionally, add an executable `bin/install.sh` or `bin/install.cmd`
  script that can install a version of the analysis tool. See
  [eslint/bin/install.sh](eslint/bin/install.sh) as an example.

It is recommended, but not required, that the driver implementation
makes use of the TypeScript libraries in this repository to avoid
reimplementing the logic around running an analysis tool on multiple
CVEs. See [eslint.ts](eslint/src/eslint.ts) as an example that uses
[driver.ts](src/driver.ts).

Finally, add a line to the [table of supported analysis tools](#supported-analysis-tools) above.

### Inputs to analysis tool driver runs

When `bin/cli run --tool <TOOL_ID>` is run, it looks up `<TOOL_ID>`
in the configuration file of the run, and executes the `bin` property
of that driver configuration with the following
positional arguments:

- 1 ... n. `custom arguments`: the values in the `arg`-property of the driver configuration
- n + 1. `tool`: the tool-id of the driver configuration
- n + 2. `targets`: a path to a json file with an array of benchmark CVEs that the analysis tool should be run on. 
  - Note that this data can include data from previous runs on the CVEs, enabling the driver to make decision based on that information
- n + 3. `output`: a path to a directory that the processed results of the analysis tool should be emitted to

As an example, consider the following setup:

Configuration file `config.json`:

```json
{
  "tools": {
    "eslint-default": {
      "bin": "node",
        "args": [
          "/home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js",
          "/home/user-name/analysis-tools/eslint-default"
         ]
      }
    }
}
```

Command-line command:

```
$ bin/cli run --tool eslint-default CVE-123-456 CVE-789-000
```

This results in the following command being executed by the CVE benchmarking tooling.

```
$ node \
  /home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js \
  /home/user-name/analysis-tools/eslint-default \
  eslint-default \
  /tmp/targets-file.json \
  /home/user-name/ossf-cve-benchmarking/work/results
```

Once the
`/home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js`
file is done executing, the
`/home/user-name/ossf-cve-benchmarking/work/results` directory should
contain one to four files with information about how the analysis tool did on the
vulnerable and fixed commits of CVE-123-456 and CVE-789-000.

### Outputs from analysis tool driver runs

When `bin/cli run ...` executes a driver, the driver
should emit files to the provided `output` directory. It is up to
`bin/run` how it names these files, but they should be valid according
to [Log.schema.json](/schemas/Log.schema.json). 


Example:
```json
{
  "CVE": "CVE-2020-4066",
  "commit": "ba6a6f13691000ffaf22ef8e731513737659447f",
  "runs": [
    {
      "toolID": "eslint@latest",
      "alerts": [ ... ],
      "status": "SUCCESS", 
      "reproduction": "...
    }
  ]
}
``` 

TODO @esbena full format explanation

### Expected analysis tool driver behaviour

drivers are expected to showcase the relevant behaviours
of its analysis tool on the commits of a CVE. 

This means that the driver ought to select the relevant rules that its
analysis tool makes use of. There is for instance little point in
running JavaScript XSS queries for a CVE that is about a buffer
overflow in C++ code. If it is known that an analysis has no relevant
rules for a CVE, it is fine to abort early without even starting the
analysis tool.

Similarly, some analysis tools may also need information about special
build instructions for the project that should be analysed in order to
produce meaningful results.

It is encouraged that the drivers makes use of such analysis tool
specific information. Such information could for instance be
downloaded as part of the install steps of a driver.

If no such external information is available for an analysis tool, the
CVE benchmark data itself also contain relevant information that the
driver could make use of, the `CWEs` of a CVE benchmark entry could
for instance indicate the queries that were relevant to run. And the
extension of the files with known weaknesses could indicate the
relevant programming language.


Of course, it is not expected that a driver "cheats" and simply
outputs the known weaknesses as if they had been detected by the
analysis tool. Rather, it is encouraged that the driver includes
reproduction steps in the results that it emits. These reproduction
steps would allow the curious users to verify or even debug the
behaviours of an analysis tool independent of the CVE benchmark
tooling.
