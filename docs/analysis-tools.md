# Analysis tools

Analysis tools are programs that analyze source code. For the purposes
of CVE benchmarking, analysis tools are expected to identify the
weaknesses in the source code that resulted in the vulnerability
associated with a CVE.

Analysis tools drivers are small scripts that act as the interface
between the analysis tools and the CVE benchmarking tooling.

The purpose of an analysis tool driver is to execute its analysis tool
appropriately on the relevant commits of a CVE and convert its results
to a common form that benchmark reports can be generated from.

## Supported analysis tools

The [contrib/tools](contrib/tools) directory contains analysis tool
drivers that have been contributed by the community. The name of
these directories is not significant, and drivers do not
have to be in this directory in order to be used by `bin/cli run`.

Some versions of the following analysis tools are supported with drivers:

| Analysis tool                                                              | Driver location                                      |
|----------------------------------------------------------------------------|------------------------------------------------------|
| [CodeQL](https://securitylab.github.com/tools/codeql)                      | [contrib/tools/codeql](contrib/tools/codeql)         |
| [eslint](https://eslint.org/)                                              | [contrib/tools/eslint](contrib/tools/eslint)         |
| [Fortify](https://www.microfocus.com/en-us/solutions/application-security) | [contrib/tools/fortify](contrib/tools/fortify)       |
| [nodejsscan](https://github.com/ajinabraham/nodejsscan)                    | [contrib/tools/nodejsscan](contrib/tools/nodejsscan) |

Additional drivers may exist, ask the analysis tool vendors about
their level of support.

## Running analysis tools

Before using `bin/cli run` to evaluate the ability of a code analysis tool
to generate alerts, you must:

- install the analysis tool.
- configure the analysis tool driver in a [configuration file](configuration.md).

### Installing an analysis tool

For each supported analysis tool, there should be documentation about how to install the tool. 
For example, see [eslint/README.md](contrib/tools/eslint/README.md) to see how to 
install `eslint`.

### Configuring an analysis tool driver

In order to be usable, a driver must be configured with an entry in the `tools` section of a configuration file (config.json). Drivers need to be configured with at least some knowledge about where their backing analysis tool is located.

When a driver is configured like above, we simply call it a "tool" throughout the  documentation.
For more information about configuration files, see [Configuration](docs/configuration.md). 

For example, to benchmark `eslint` you must insert the 
following snippet in your configuration file:

```json
{
    "tools": {
        "eslint-default": {
            "bin": "node",
            "args": [
                "/home/user-name/ossf-cve-benchmark/build/ts/contrib/tools/eslint/src/eslint.js",
                "/home/user-name/analysis-tools/eslint-default"
            ]
        }
    }
}
```

This snippet provides the identifier you must use when using `bin/cli` commands
that require a `--tools` option. For example, in the snippet above `eslint-default` 
is the identifier for using `eslint` with `bin/cli run`. 

## Writing analysis tool drivers

To add support for a new analysis tool, you must write an
analysis tool driver. To add a new driver you must:

- Add a new directory to the [contrib/tools](contrib/tools)
- Add a `README.md` file that describes how the analysis tool can be
  installed, and how the driver can be configured.
- Optionally, add an executable `installers/install.sh` or `installers/install.cmd`
  script that can install a version of the analysis tool. For example, see
  [eslint/installers/install.sh](eslint/installers/install.sh).
- Add your new driver to the [table of supported analysis tools](#supported-analysis-tools).

When adding support for a new driver, we recommended using the TypeScript 
libraries in this repository to avoid reimplementing the existing logic for
running analysis tools on multiple CVEs. For more information about using
[driver.ts](src/driver.ts) in a new driver, see [eslint.ts](eslint/src/eslint.ts).

### Inputs to analysis tool driver runs

When you run `bin/cli run`, you are required to supply a tool 
identifier `<TOOL_ID>` with the ` --tool` option. `bin/cli` 
looks up `<TOOL_ID>` in the configuration file of the run, 
and executes the `bin` property of that driver configuration
with the following positional arguments:

- 1 ... n. `fixed arguments`: the values in the `args` property of the driver configuration. 
  - this is usually just a single string that points to the driver implementation
- n + 1. `options`: a path to a dynamically generated JSON file that contains the inputs for the driver. 
  - the format of this JSON file is descibed by the [`DriverInputs`](docs/json-schema/ts-defs-definitions-driverinputs.md) type

For example, consider the following:

Configuration file `config.json`:

```json
{
  "tools": {
    "eslint-default": {
      "bin": "node",
        "args": [
          "/home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js"
         ]
      },
      "options": {
        "eslintDir": "/home/user-name/analysis-tools/eslint-2020-12-08"
      }
    }
}
```

Command-line command:

```
$ bin/cli run --tool eslint-default CVE-123-456 CVE-789-000
```

This results in the following command being executed by the CVE benchmarker:

```
$ node \
  /home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js \
  /tmp/driver-inputs.json 
```

The JSON file with the driver inputs contains the `--tool` option
value, the [`CVEs`](docs/json-schema/ts-defs-definitions-bcve.md) to
analyze, and the [`effective
configuration`](docs/json-schema/ts-defs-definitions-config.md).

The effective configuration contains two things of particular interest here:

- the `tools.<TOOL_ID>.options`: a driver-specific JSON value with
  additional configuration options for the driver, for instance where
  the analysis tool is installed
- `results`: the directory where the driver should emit [result
  files](docs/json-schema/ts-defs-definitions-bcvelog.md) for the
  analysis of each CVE

Continuing the example fom above, the `/tmp/driver-inputs.json` file will contain the following fragments:

```json
{
  "toolID": "eslint-default",
  "bcves": [ { "CVE": "CVE-123-456", ... }, { "CVE": "CVE-789-000", ... } ],
  "config": {
    "results": "/home/user-name/ossf-cve-benchmarking/work/results",
    "tools": { 
      "eslint-default": {
        "bin": "node",
          "args": [
            "/home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js"
           ]
        },
        "options": {
          "eslintDir": "/home/user-name/analysis-tools/eslint-2020-12-08"
        }
      },
      ...
    }
  }
}
```

So after
`/home/user-name/ossf-cve-benchmarking/build/ts/contrib/tools/eslint/src/eslint.js`
has executed the `eslint` installed at `/home/user-name/analysis-tools/eslint-2020-12-08`, the
`/home/user-name/ossf-cve-benchmarking/work/results` directory should
contain one to four files with information about how the analysis tool performed on the
vulnerable and fixed commits of CVE-123-456 and CVE-789-000.

### Outputs from analysis tool driver runs

When `bin/cli run ...` executes a driver, the driver
should emit files to the provided `results` directory. It is up to
`bin/run` how it names these files, but they should be valid according
to [Log.schema.json](/schemas/Log.schema.json). 


Example:
```json
{
  "CVE": "CVE-2020-4066",
  "commit": "ba6a6f13691000ffaf22ef8e731513737659447f",
  "runs": [
    {
      "toolID": "eslint-default",
      "alerts": [ ... ],
      "status": "SUCCESS", 
      "reproduction": "...
    }
  ]
}
``` 

TODO @esbena full format explanation

### Expected analysis tool driver behavior

When analyzing the commits of a CVE, drivers are expected to behave in
much the same way as when the corresponding analysis tool has been
configured by an expert.

This means that the driver should use the analysis rules that are
relevant for the CVE. There is, for instance, little point in running
JavaScript XSS queries for a CVE that is about a buffer overflow in
C++ code. If a driver establishes that an analysis has no relevant
rules for a particular CVE, it is fine to abort early without starting
the analysis run.

Similarly, some analysis tools may also need information about special
build instructions for the project that is to be analyzed in order to
produce meaningful results. We encourage drivers to make use of such analysis tool
specific information. Such information could, for instance, be
downloaded as part of the install steps of a driver.

If no such external information is available for an analysis tool, the
CVE benchmark data also contain relevant information that the
driver could make use of. For instance, the `CWEs` of a CVE benchmark 
entry could indicate the queries that were relevant to run.  Additionally, 
the extension of the files with known weaknesses could indicate the
relevant programming language.

Of course, it is not expected that a driver "cheats" and simply
outputs the known weaknesses as if they had been detected by the
analysis tool. Rather, it is encouraged that the driver includes
reproduction steps in its outputs. Users can then follow these
steps to verify or even debug the behaviors of an analysis tool independent 
of the CVE benchmark tooling.
