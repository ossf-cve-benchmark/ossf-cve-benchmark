// XXX make this be even more idiomatic React
import * as React from "react";
import * as ReactDOM from "react-dom";
import CVEBenchmarkScoreTable from "./CVEBenchmarkScoreTable";
import * as CVEResults from "./CVEResults";
import {
  cachingJSONFetch,
  compareToolIDs,
  getCve2tool2commitRuns,
  mkSimpleURL
} from "./util";
require("./style.css");

(async function() {
  const urlParams = new URLSearchParams(window.location.search);

  let cve = urlParams.get("CVE");
  let content: JSX.Element;
  let toolIDs = (
    await cachingJSONFetch(mkSimpleURL("/data/getToolIds", {}))
  ).sort(compareToolIDs);
  if (cve) {
    let toolRuns = getCve2tool2commitRuns(
      await cachingJSONFetch(mkSimpleURL("/data/getAllToolRuns", {}))
    );
    let cwes = (await cachingJSONFetch(mkSimpleURL("/data/getCVE2CWEs", {})))[
      cve
    ];
    content = (
      <CVEResults.CVEResults
        CVE={cve}
        toolIDs={toolIDs}
        toolRuns={toolRuns[cve] || {}}
        CWEs={cwes}
      />
    );
  } else {
    let cves = await cachingJSONFetch(mkSimpleURL("/data/getCVEs", {}));
    content = <CVEBenchmarkScoreTable CVEs={cves} toolIDs={toolIDs} />;
  }
  ReactDOM.render(content, document.getElementById("main"));
})();
