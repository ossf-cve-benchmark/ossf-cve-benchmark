/**
 * This file contains the types used for persistent data in this project: most notably the CVE benchmark data and analysis results for them.
 *
 * This file should not contain types for values that are not going to be persisted.
 *
 * JSON schemas and associated documentation will be generated from this file, so everything ought to be documented thoroughly.
 */

export type Dir = string;
export type File = string;
export type CVEString = string;
export type RepositoryIdentifier = string;
export type CommitID = string;
export type ToolID = string;
export type RuleID = string;
export type CWEString = string;

/**
 * A source location.
 *
 * @title SourceLocation
 */
export type SourceLocation = {
  /**
   * The path to the file.
   */
  file: File;
  /**
   * The line number.
   */
  lines: number[];
};

/**
 * A weakness in some source code.
 *
 * @title Weakness
 */
export type Weakness = {
  /**
   * The source location of the weakness, relative to the root of the vulnerable project
   */
  location: {
    /**
     * The path to the file.
     */
    file: File;
    /**
     * The line number.
     */
    line: number;
    /**
     * The implicit file extension of `file`, e.g. 'js' or 'sh'
     */
    implicitExtension?: string;
  };

  /**
   * An explanation for this weakness.
   */
  explanation: string;
};

/**
 * An alert raised by an analysis tool.
 *
 * @title BCVEAlert
 */
export type BCVEAlert = {
  /**
   * The source location of the weakness, relative to the root of the vulnerable project
   */
  location: SourceLocation;

  /**
   * The ID of the rule that produced this alert.
   */
  ruleID: RuleID;

  /**
   * The URL for additional information about this alert.
   */
  url?: string;
};

/**
 * A description of a commit that is related to a CVE.
 *
 * @title CommitDescription
 */
export type CommitDescription = {
  /**
   * The commit.
   */
  commit: CommitID;

  /**
   * The local source directory whe the source code for this commit is located, if any.
   */
  localSourceDirectory?: Dir;

  /**
   * The weaknesses related to the CVE of this commit, if any.
   */
  weaknesses?: Weakness[];

  /**
   * A collection of analysis tool runs for this commit, if any.
   */
  runs?: BCVERun[];
};

/**
 * The state of a CVE. See https://cve.mitre.org/about/terminology.html#cve_record
 *
 * @title CVEState
 */
export enum CVEState {
  PUBLISHED = "PUBLISHED",
  DISPUTED = "DISPUTED",
  REJECTED = "REJECTED",
  RESERVED = "RESERVED"
}

/**
 * A benchmark CVE.
 *
 * See docs/benchmark-CVEs.md for an in-depth explanation of this type.
 *
 * @title BCVE
 */
export type BCVE = {
  /**
   * The CVE identifier.
   */
  CVE: CVEString;
  /**
   * The CVE state of the CVE
   */
  state: CVEState;
  /**
   * The string that identifies the repository that hosts the commits.
   */
  repository: RepositoryIdentifier;
  /**
   * The prePatch commit.
   * @title prePatch
   */
  prePatch: CommitDescription;
  /**
   * The postPatch commit.
   */
  postPatch: CommitDescription;
  /**
   * The relevant CWEs for the weaknesses.
   */
  CWEs?: CWEString[];
};

/**
 * A run of an analysis tool on a commit related to a CVE.
 *
 * @title StandaloneRun
 */
export type StandaloneRun = BCVERun & {
  /**
   * The CVE identifier.
   */
  CVE: CVEString;
  /**
   * The commit.
   */
  commit: CommitID;
};

/**
 * A run of an analysis tool on some source code.
 *
 * @title BCVERun
 */
export type BCVERun = {
  /**
   * An ID for the tool of the run.
   */
  toolID: ToolID;
  /**
   * The alerts produced by the tool.
   */
  alerts?: BCVEAlert[];
  /**
   * The final status for the run.
   */
  status: BCVEResultStatus;
  /**
   * A command-line string that enables reproduction of the run independent of the benchmarking tooling.
   */
  reproduction?: string;
};

/**
 * A collection of analysis tool runs.
 *
 * @title BCVELog
 */
export type BCVELog = {
  /**
   * The runs.
   */
  runs: StandaloneRun[];
};

/**
 * A simple status for a run of an analysis tool.
 *
 * The run itself should contain enough information to reproduce the missing details.
 *
 * @title BCVEResultStatus
 */
export enum BCVEResultStatus {
  /**
   * The run completed successfully.
   */
  SUCCESS = "SUCCESS",
  /**
   * The run exceeded a timeout limit.
   */
  TIMEOUT = "TIMEOUT",
  /**
   * The run crashed.
   */
  CRASH = "CRASH",
  /**
   * The CVE is known not to be supported by the analysis tool, and the tool has not been run.
   *
   * The vulnerability could for instance be in an unsupported language.
   */
  UNSUPPORTED = "UNSUPPORTED",
  /**
   * The run triggered an error in the benchmarking framework itself.
   *
   * This should be reported to the maintainers of the benchmarking framework.
   */
  FRAMEWORK_ERROR = "FRAMEWORK_ERROR"
}

/**
 * A collection of exported benchmark CVEs.
 *
 * @title Export
 */
export type Export = BCVE[];

/**
 * A configuration object.
 *
 * @title Config
 */
export type Config = {
  /**
   * The configuration file that defines (some of) these values.
   */
  "config-file"?: File;

  /**
   * The directory where the Benchmark CVEs are located.
   */
  bcves?: Dir;

  /**
   * The directory where the source code for the CVEs are located.
   */
  sources?: Dir;

  /**
   * The directory where the results for the analysis tool runs are located.
   */
  results?: Dir;

  /**
   * The directory where the reports are located.
   */
  reports?: Dir;

  /**
   * The file that is exported to.
   */
  export?: File;

  /**
   * The configurations of the analysis tool drivers.
   */
  tools?: {
    /**
     * The name of the driver, and the associated options.
     */
    [toolName: string]: DriverConfig<any>;
  };

  /**
   * The location where canonical repositories exists for each CVE as `<root>/<CVE>.git`.
   */
  "canonical-repositories-root"?: string;
};

/**
 * A configuration for how to run an analysis tool driver.
 *
 * @title DriverConfig
 */
export type DriverConfig<T> = {
  /**
   * The binary to execute with the `run` command.
   */
  bin: string;
  /**
   * The leading arguments to execute the `bin` with. These arguments are followed by a single argument with a run-specific input file.
   */
  args: string[];
  /**
   * The time in milliseconds that the driver will permit the analysis tool to analyze a commit in.
   */
  timeout?: number;
  /**
   * Additional options for the driver (preferred over a long `args` arrray).
   */
  options?: T;
};

/**
 * The inputs accessible to the drivers that are executed by the `run` command (the inputs are provided as a JSON file, pointed to by the last commandline argument).
 */
export type DriverInputs = {
  /**
   * The ID of the tool that is being run.
   */
  toolID: ToolID;
  /**
   * The benchmark CVEs to analyze.
   */
  bcves: BCVE[];
  /**
   * The effective configuration used by the Benchmarker.
   */
  config: Config;
};
