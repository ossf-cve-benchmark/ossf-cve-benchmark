#!/bin/bash

# installs codeql in $1

set -e
MYDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

INSTALL_DIR=$1

if [[ -z "$INSTALL_DIR" ]]; then
    echo "Missing an argument.
Usage: $0 directory-to-install-codeql-in" >&2
   exit 1
fi

function abspath() { pushd . > /dev/null; if [ -d "$1" ]; then cd "$1"; dirs -l +0; else cd "`dirname \"$1\"`"; cur_dir=`dirs -l +0`; if [ "$cur_dir" == "/" ]; then echo "$cur_dir`basename \"$1\"`"; else echo "$cur_dir/`basename \"$1\"`"; fi; fi; popd > /dev/null; }
INSTALL_DIR=$(abspath "$INSTALL_DIR")

mkdir -p "${INSTALL_DIR}"
TMP=$(mktemp -d codeql-download-XXXX)
BUNDLE=/bundle.tar.gz

cd $TMP
NAME=codeql-bundle.tar.gz
curl -LO "https://github.com/github/codeql-action/releases/latest/download/${NAME}"
tar xvf "${NAME}" -C "${INSTALL_DIR}"

INFO="${INSTALL_DIR}/cve-information.json"
# XXX host this elsewhere
curl https://gist.githubusercontent.com/esbena/a0da68919771d0078efb4ef5428c5f1b/raw/20cc7b84ff83efda77a212239e4566d8ce6d99aa/codeql-cve-information.json > "${INFO}"

MAIN="${MYDIR}/../../../../build/ts/contrib/tools/codeql/src/codeql.js"
MAIN=$(abspath "$MAIN")
echo "The codeql tool has been installed. Add the fragment below to a config.json file:

{
    ...
    \"tools\": {
        ...

        \"codeql-default\": {
            \"bin\": \"node\",
            \"args\": [
                \"${MAIN}\"
            ],
            \"options\": {
              \"codeql\": \"${INSTALL_DIR}/codeql/codeql\",
              \"cveInformation\": \"${INFO}\"
            }

        }

        ...
    }
    ...
}

"
